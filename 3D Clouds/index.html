<html>

	<head>
		<title>CSS 3D Clouds Background</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="description" content="CSS 3D Clounds background, updating depends on weather (API) and CSS Animation" />
		<meta name="keywords" content="CSS, CSS Animation, CSS 3D, Weather API" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<link href='http://fonts.googleapis.com/css?family=Lato:900' rel='stylesheet' type='text/css' />
		<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css' />
		<link href='style/buttons.css' rel='stylesheet' type='text/css' />
		<link href='style/styles.css' rel='stylesheet' type='text/css' />
		<script src="script/script.js"></script>

		<!-- ................................................................................... -->
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<!-- ................................................................................... -->


	</head>

	<body>

		<div id="viewport">

			<div id="parent_id" class="weather_id">
				<h1 class="weather_id" title = 'Click "Get weather" to change background in depends the weather in Varna'>Weather</h1>
				<br />

				<div class="weather_id" title = "Click to change background in depends the weather in Varna"><a href="#" class="get_weather" id = "get_weather">Get weather</a>
				</div>
				<div id="result" class="weather_id" style="display: none">
					<div id="icon"></div>
					<div id="city"><strong></strong>
					</div>
					<div id="weather"></div>
					<div id="time"></div>
					<div><a href="#" class="hide" id = "hide_weather">Hide</a>
					</div>
				</div>
			</div>

			<div id="click_customize" class="hvr-pulse-grow">
				<h1 onclick="myFunction()">Click to customize</h1>
			</div>

			<div id = "help_id">

				<h1>Keyboard keys</h1>
				<p>Ctrl + Shift + (1-5) - Change presets</p>
				<p>Space - Generate clouds</p>
				<p>C - Customize</p>
				<p>F - Full screen</p>
				<p>Escape - Close</p>
				<p>G - Get weather</p>
				<p>H - Hide weather</p>
				<p>K - Open keyboard keys</p>
				<button type="button" id = "btn_close" onclick = "HideOnClick()">Close</button>
				
			</div>

			<img class = "hvr-pulse-grow" id = "icon" src="image/question.png" alt = "question icon" onclick="FuntionHelp()">

			<div id="world">
			</div>
		</div>

		<div class="sun" id = "id_sun">
		</div>

		<div id="options">
			<a href="#" id="closeBtn" class="button">X</a>
			<h1>CSS 3D Clouds</h1>
			<div id="optionsContent">
				<p>Move the <b>mouse to rotate</b> around and <b>mouse wheel to zoom</b> in and out. Hit <b>space to generate</b> a new cloud.</p>
				<div class="actions">
					<a class="button" href="#" id="generateBtn">Generate clouds</a> <a class="button" href="#" id="showTextureControlsBtn" title = 'After choose your controls hit "Generate clouds".&#13;The Sun, bird and plane are shown only on presets.'>Show controls</a> <a class="button" href="#" id="fullscreenBtn">Fullscreen</a>
				</div>
				<div id="textureControls">
					<h2>Controls list</h2>
					<p>Select one or more textures to create clouds</p>
					<ul id="textureList">
					</ul>
				</div>
				<h2>Presets</h2>
				<div class="presets">
					<a href="#" class="left button" id="clear">Clear</a>
					<a href="#" class="left button" id="cloudsPreset">Cloudy</a>
					<a href="#" class="middle button" id="stormPreset">Overcast</a>
					<a href="#" class="middle button" id="boomPreset">Chance of rain</a>
					<a href="#" class="right button" id="bayPreset">Storm</a>
				</div>
				<div style="clear:both; height: 20px; display: block"></div>

				<br />

			</div>
		</div>

		<img src="image/bird.png" id="pajaro" class="piopio">
		<img src="image/plane.png" id="plane" class="piopio">


		<script>
			function getParameterByName(name) {
				name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
				var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
					results = regex.exec(location.search);
				return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			var isKosher = getParameterByName('metadata').indexOf('Player') === -1;

			(function() {
				var lastTime = 0;
				var vendors = ['ms', 'moz', 'webkit', 'o'];
				for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
					window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
					window.cancelRequestAnimationFrame = window[vendors[x] +
						'CancelRequestAnimationFrame'];
				}

				if (!window.requestAnimationFrame)
					window.requestAnimationFrame = function(callback, element) {
						var currTime = new Date().getTime();
						var timeToCall = Math.max(0, 16 - (currTime - lastTime));
						var id = window.setTimeout(function() {
								callback(currTime + timeToCall);
							},
							timeToCall);
						lastTime = currTime + timeToCall;
						return id;
					};

				if (!window.cancelAnimationFrame)
					window.cancelAnimationFrame = function(id) {
						clearTimeout(id);
					};
			}())

			var layers = [],
				objects = [],
				textures = [],

				world = document.getElementById('world'),
				viewport = document.getElementById('viewport'),

				d = 0,
				p = 400,
				worldXAngle = 0,
				worldYAngle = 0,
				computedWeights = [];

			var links = document.querySelectorAll('a[rel=external]');
			for (var j = 0; j < links.length; j++) {
				var a = links[j];
				a.addEventListener('click', function(e) {
					window.open(this.href, '_blank');
					e.preventDefault();
				}, false);
			}

			viewport.style.webkitPerspective = p;
			viewport.style.MozPerspective = p + 'px';
			viewport.style.oPerspective = p;
			viewport.style.perspective = p;


			textures = [{
				name: 'white cloud',
				file: 'image/cloud.png',
				opacity: 1,
				weight: 0
			}, {
				name: 'dark cloud',
				file: 'image/darkCloud.png',
				opacity: 1,
				weight: 0
			}, {
				name: 'smoke cloud',
				file: 'image/smoke.png',
				opacity: 1,
				weight: 0
			}, {
				name: 'explosion',
				file: 'image/explosion.png',
				opacity: 1,
				weight: 0
			}, {
				name: 'explosion 2',
				file: 'image/explosion2.png',
				opacity: 1,
				weight: 0
			}, {
				name: 'lightnings',
				file: 'image/box.gif',
				opacity: 1,
				weight: 0
			}];

			var el = document.getElementById('textureList');
			for (var j = 0; j < textures.length; j++) {
				var li = document.createElement('li');
				var span = document.createElement('span');
				span.textContent = textures[j].name;
				var div = document.createElement('div');
				div.className = 'buttons';
				var btnNone = document.createElement('a');
				btnNone.setAttribute('id', 'btnNone' + j);
				btnNone.setAttribute('href', '#');
				btnNone.textContent = 'None';
				btnNone.className = 'left button';
				var btnFew = document.createElement('a');
				btnFew.setAttribute('id', 'btnFew' + j);
				btnFew.setAttribute('href', '#');
				btnFew.textContent = 'A few';
				btnFew.className = 'middle button';
				var btnNormal = document.createElement('a');
				btnNormal.setAttribute('id', 'btnNormal' + j);
				btnNormal.setAttribute('href', '#');
				btnNormal.textContent = 'Some';
				btnNormal.className = 'middle button';
				var btnLot = document.createElement('a');
				btnLot.setAttribute('id', 'btnLot' + j);
				btnLot.setAttribute('href', '#');
				btnLot.textContent = 'A lot';
				btnLot.className = 'right button';

				(function(id) {
					btnNone.addEventListener('click', function() {
						setTextureUsage(id, 'None');
					});
					btnFew.addEventListener('click', function() {
						setTextureUsage(id, 'Few');
					});
					btnNormal.addEventListener('click', function() {
						setTextureUsage(id, 'Normal');
					});
					btnLot.addEventListener('click', function() {
						setTextureUsage(id, 'Lot');
					});
				})(j);

				li.appendChild(span);
				div.appendChild(btnNone);
				div.appendChild(btnFew);
				div.appendChild(btnNormal);
				div.appendChild(btnLot);
				li.appendChild(div);
				el.appendChild(li);

				setTextureUsage(j, 'None');
			}

			setTextureUsage(0, 'Lot'); //by default, on start up
			generate();

			document.getElementById('clear').addEventListener('click', function(e) {
				setTextureUsage(0, 'None');
				setTextureUsage(1, 'None');
				setTextureUsage(2, 'None');
				setTextureUsage(3, 'None');
				setTextureUsage(4, 'None');
				setTextureUsage(5, 'None');
				generate();
				e.preventDefault();
				document.getElementById("id_sun").style.display = "block";
				document.getElementById("pajaro").style.display = "block";
				document.getElementById("plane").style.display = "block";
			});

			document.getElementById('cloudsPreset').addEventListener('click', function(e) {
				setTextureUsage(0, 'Lot');
				setTextureUsage(1, 'None');
				setTextureUsage(2, 'None');
				setTextureUsage(3, 'None');
				setTextureUsage(4, 'None');
				setTextureUsage(5, 'None');
				generate();
				e.preventDefault();
				document.getElementById("id_sun").style.display = "block";
				document.getElementById("pajaro").style.display = "block";
				document.getElementById("plane").style.display = "block";
			});

			document.getElementById('stormPreset').addEventListener('click', function(e) {
				setTextureUsage(0, 'None');
				setTextureUsage(1, 'None');
				setTextureUsage(2, 'Lot');
				setTextureUsage(3, 'None');
				setTextureUsage(4, 'None');
				setTextureUsage(5, 'None');
				generate();
				e.preventDefault();
				document.getElementById("id_sun").style.display = "none";
				document.getElementById("pajaro").style.display = "none";
				document.getElementById("plane").style.display = "none";
			});

			document.getElementById('boomPreset').addEventListener('click', function(e) {
				setTextureUsage(0, 'None');
				setTextureUsage(1, 'None');
				setTextureUsage(2, 'Lot');
				setTextureUsage(3, 'Few');
				setTextureUsage(4, 'None');
				setTextureUsage(5, 'None');
				generate();
				e.preventDefault();
				document.getElementById("id_sun").style.display = "none";
				document.getElementById("pajaro").style.display = "none";
				document.getElementById("plane").style.display = "none";
			});

			document.getElementById('bayPreset').addEventListener('click', function(e) {
				setTextureUsage(0, 'None');
				setTextureUsage(1, 'None');
				setTextureUsage(2, 'Normal');
				setTextureUsage(3, 'Lot');
				setTextureUsage(4, 'Lot');
				setTextureUsage(5, 'Few');
				generate();
				e.preventDefault();
				document.getElementById("id_sun").style.display = "none";
				document.getElementById("pajaro").style.display = "none";
				document.getElementById("plane").style.display = "none";
			});

			function setTextureUsage(id, mode) {
				var modes = ['None', 'Few', 'Normal', 'Lot'];
				var weights = {
					'None': 0,
					'Few': .3,
					'Normal': .7,
					'Lot': 1
				};
				for (var j = 0; j < modes.length; j++) {
					var el = document.getElementById('btn' + modes[j] + id);
					el.className = el.className.replace(' active', '');
					if (modes[j] == mode) {
						el.className += ' active';
						textures[id].weight = weights[mode];
					}
				}
			}
			/*...................................................................................................*/
			/*...................................................................................................*/
			/*...................................................................................................*/
			var optionsContent = document.getElementById('optionsContent');
			var opt = document.getElementById('options'); /*..........*/
			var el = document.getElementById('closeBtn').addEventListener('click', function(e) {
				/*		if( optionsContent.style.display != 'block' ) {
							optionsContent.style.display = 'block';
						} else {*/
				opt.style.display = 'none'; //vmesto opt beshe optionsCOntent
				/*		}*/
				/*e.preventDefault();*/
			});

			/*...................................................................................................*/
			/*...................................................................................................*/
			/*...................................................................................................*/

			var textureControls = document.getElementById('textureControls');
			var el = document.getElementById('showTextureControlsBtn').addEventListener('click', function(e) {
				if (textureControls.style.display != 'block') {
					textureControls.style.display = 'block';
				}
				else {
					textureControls.style.display = 'none';
				}
				e.preventDefault();
			});

			var el = document.getElementById('fullscreenBtn');
			if (el) {
				var options = document.getElementById('options');
				el.addEventListener('click', function(e) {
					if (document.body.webkitRequestFullScreen) {
						document.body.onwebkitfullscreenchange = function(e) {
							//	options.style.display = 'none';
							document.body.style.width = window.innerWidth + 'px';
							document.body.style.height = window.innerHeight + 'px';
							document.body.onwebkitfullscreenchange = function() {
								//		options.style.display = 'block';
							};
						};
						document.body.webkitRequestFullScreen();
					}

					if (document.body.mozRequestFullScreen) {
						/*				document.body.onmozfullscreenchange = function( e ) {
											options.style.display = 'none';
											document.body.onmozfullscreenchange = function( e ) {
												options.style.display = 'block';
											};
										};*/
						document.body.mozRequestFullScreen();
					}
					e.preventDefault();
				}, false);
			}

			function createCloud() {

				var div = document.createElement('div');
				div.className = 'cloudBase';
				var x = 256 - (Math.random() * 512);
				var y = 256 - (Math.random() * 512);
				var z = 256 - (Math.random() * 512);
				var t = 'translateX( ' + x + 'px ) translateY( ' + y + 'px ) translateZ( ' + z + 'px )';
				div.style.webkitTransform =
					div.style.MozTransform =
					div.style.oTransform =
					div.style.transform = t;
				world.appendChild(div);

				for (var j = 0; j < 5 + Math.round(Math.random() * 10); j++) {
					var cloud = document.createElement('img');
					cloud.style.opacity = 0;
					var r = Math.random();
					var src = 'image/troll.png';
					for (var k = 0; k < computedWeights.length; k++) {
						if (r >= computedWeights[k].min && r <= computedWeights[k].max) {
							(function(img) {
								img.addEventListener('load', function() {
									img.style.opacity = .8;
								})
							})(cloud);
							src = computedWeights[k].src;
						}
					}
					if (!isKosher) src = 'troll.png';
					cloud.setAttribute('src', src);
					cloud.className = 'cloudLayer';

					var x = 256 - (Math.random() * 512);
					var y = 256 - (Math.random() * 512);
					var z = 100 - (Math.random() * 200);
					var a = Math.random() * 360;
					var s = .25 + Math.random();
					x *= .2;
					y *= .2;
					cloud.data = {
						x: x,
						y: y,
						z: z,
						a: a,
						s: s,
						speed: .1 * Math.random()
					};
					var t = 'translateX( ' + x + 'px ) translateY( ' + y + 'px ) translateZ( ' + z + 'px ) rotateZ( ' + a + 'deg ) scale( ' + s + ' )';
					cloud.style.webkitTransform =
						cloud.style.MozTransform =
						cloud.style.oTransform =
						cloud.style.transform = t;

					div.appendChild(cloud);
					layers.push(cloud);
				}

				return div;
			}

			window.addEventListener('mousewheel', onContainerMouseWheel);
			window.addEventListener('DOMMouseScroll', onContainerMouseWheel);
			//window.addEventListener( 'deviceorientation', orientationhandler, false );
			//window.addEventListener( 'MozOrientation', orientationhandler, false );

			document.getElementById('generateBtn').addEventListener('click', function(e) {
				generate();
				e.preventDefault();
			});

			window.addEventListener('keydown', function(e) {
				if (e.keyCode == 32) generate();
			});


			window.addEventListener('mousemove', function(e) {
				worldYAngle = -(.5 - (e.clientX / window.innerWidth)) * 180;
				worldXAngle = (.5 - (e.clientY / window.innerHeight)) * 180;
				//worldXAngle = .1 * ( e.clientY - .5 * window.innerHeight );
				//worldYAngle = .1 * ( e.clientX - .5 * window.innerWidth );
				updateView();
			});

			window.addEventListener('touchmove', function(e) {
				var ptr = e.changedTouches.length;
				while (ptr--) {
					var touch = e.changedTouches[ptr];
					worldYAngle = -(.5 - (touch.pageX / window.innerWidth)) * 180;
					worldXAngle = (.5 - (touch.pageY / window.innerHeight)) * 180;
					updateView();
				}
				e.preventDefault();
			});

			function generate() {
				objects = [];
				if (world.hasChildNodes()) {
					while (world.childNodes.length >= 1) {
						world.removeChild(world.firstChild);
					}
				}
				computedWeights = [];
				var total = 0;
				for (var j = 0; j < textures.length; j++) {
					if (textures[j].weight > 0) {
						total += textures[j].weight;
					}
				}
				var accum = 0;
				for (var j = 0; j < textures.length; j++) {
					if (textures[j].weight > 0) {
						var w = textures[j].weight / total;
						computedWeights.push({
							src: textures[j].file,
							min: accum,
							max: accum + w
						});
						accum += w;
					}
				}
				for (var j = 0; j < 5; j++) {
					objects.push(createCloud());
				}
			}

			function updateView() {
				var t = 'translateZ( ' + d + 'px ) rotateX( ' + worldXAngle + 'deg) rotateY( ' + worldYAngle + 'deg)';
				world.style.webkitTransform =
					world.style.MozTransform =
					world.style.oTransform =
					world.style.transform = t;
			}

			function onContainerMouseWheel(event) {

				event = event ? event : window.event;
				d = d - (event.detail ? event.detail * -5 : event.wheelDelta / 8);
				updateView();

			}

			function orientationhandler(e) {

				if (!e.gamma && !e.beta) {
					e.gamma = -(e.x * (180 / Math.PI));
					e.beta = -(e.y * (180 / Math.PI));
				}

				var x = e.gamma;
				var y = e.beta;

				worldXAngle = y;
				worldYAngle = x;
				updateView();

			}

			function update() {

				for (var j = 0; j < layers.length; j++) {
					var layer = layers[j];
					layer.data.a += layer.data.speed;
					var t = 'translateX( ' + layer.data.x + 'px ) translateY( ' + layer.data.y + 'px ) translateZ( ' + layer.data.z + 'px ) rotateY( ' + (-worldYAngle) + 'deg ) rotateX( ' + (-worldXAngle) + 'deg ) rotateZ( ' + layer.data.a + 'deg ) scale( ' + layer.data.s + ')';
					layer.style.webkitTransform =
						layer.style.MozTransform =
						layer.style.oTransform =
						layer.style.transform = t;
					//layer.style.webkitFilter = 'blur(5px)';
				}

				requestAnimationFrame(update);

			}

			update();

			/*.....................................................................................................................*/
			/*.....................................................................................................................*/
			/*.....................................................................................................................*/

			/*	document.getElementById("bayPreset").click();*/

			/*	$( function() {
				    $( "#options" ).draggable();
				  } );*/

			$(function() {
				$("#options").draggable({
					containment: "window"
				});
			});

			$(function() {
				$("#help_id").draggable({
					containment: "window"
				});
			});

		</script>


		<script type="text/javascript">
			var jsonFile;
			var weatherGet;

			$(document).ready(function() {

				function getWeather() {
					$.ajax('http://api.wunderground.com/api/b1343d7831a23146/conditions/q/BG/Varna.json', {
						dataType: 'jsonp',
						success: function(json) {
							jsonFile = json;
							weatherGet = json.current_observation.weather;

							//Clear, Partly Cloudy, Overcast/Mostly cloudy, Chance of rain, Thunderstorm 

							if (weatherGet == "Thunderstorm") {
								document.getElementById("bayPreset").click();
								document.getElementById("id_sun").style.display = "none";
								document.getElementById("pajaro").style.display = "none";
								document.getElementById("plane").style.display = "none";
								
							}
							else if (weatherGet == "Chance of rain") {
								document.getElementById("boomPreset").click();
								document.getElementById("id_sun").style.display = "none";
								document.getElementById("pajaro").style.display = "none";
								document.getElementById("plane").style.display = "none";

							}
							else if ((weatherGet == "Overcast") || (weatherGet == "Mostly Cloudy")) {
								document.getElementById("stormPreset").click();
								document.getElementById("id_sun").style.display = "none";
								document.getElementById("pajaro").style.display = "none";
								document.getElementById("plane").style.display = "none";
							}
							else if (weatherGet == "Partly Cloudy") {
								document.getElementById("cloudsPreset").click();
								document.getElementById("id_sun").style.display = "block";
								document.getElementById("pajaro").style.display = "block";
								document.getElementById("plane").style.display = "block";
							}
							else if (weatherGet == "Clear") {
									document.getElementById("clear").click();
									document.getElementById("options").style.display = "none";
									document.getElementById("id_sun").style.display = "block";
									document.getElementById("pajaro").style.display = "block";
									document.getElementById("plane").style.display = "block";			
							}


							var showTime = json.current_observation.observation_time_rfc822;
							var timeToShow = showTime.slice(0, -6);

							$('div#city strong').text(json.current_observation.display_location.full)
							$('div#icon').html('<img src=' + json.current_observation.icon_url + ' />')
							$('div#weather').text(json.current_observation.temp_c + " °C ( " + json.current_observation.feelslike_c +" )"  + " - " + json.current_observation.weather);
							$('div#time').text(timeToShow);
						}
					});
				}

				$('a.get_weather').click(function(e) {
					e.preventDefault();
					$(this).hide();
					getWeather();
					$('#result').fadeIn(1000);
				});

				$('a.hide').click(function(e) {
					e.preventDefault();
					$('#result').hide();
					$('a.get_weather').show();
				})

			})

			$("#showTextureControlsBtn").click(function() {
				$(this).toggleClass("color_change");
				$("#pajaro").hide();
				$("#plane").hide();
				$("#id_sun").hide();

			});


		</script>

	</body>

</html>
